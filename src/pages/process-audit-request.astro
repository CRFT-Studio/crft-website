---
export const prerender = false;

const out = Astro.redirect("/audit");
if (Astro.request.method !== "POST") return out;

const fields = ["First Name", "Last Name", "Work Email", "Website URL", "Role", "Notes"];
const formData = await Astro.request.formData();
const params = fields.reduce((a, c) => { a[c] = formData.get(c); return a; }, {});
if (!fields.filter(field => field !== "Notes").every(field => params[field])) return out;

import { Resend } from 'resend';
const resend = new Resend(import.meta.env.RESEND_API);

resend.emails.send({
  from: 'jeremy@crft.studio',
  to: 'hi@crft.studio',
  subject: 'Thanks for requesting a website audit!',
  html: `<p>Thank you, ${firstName} ${lastName}!</p>
  <p>We'll send a confirmation email to: ${email}</p>
  <p>Website URL: ${websiteUrl}</p>
  <p>Role: ${role}</p>`
});
---