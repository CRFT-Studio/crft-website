---
export const prerender = false;
const { env, session } = Astro.locals.runtime;
const PAGESPEED_API = env.PAGESPEED_API ?? import.meta.env.PAGESPEED_API;
const { url } = Astro.props;

if (url) {
    try {
        const encodedUrl = encodeURIComponent(url);
        const response = await fetch(
            `https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${encodedUrl}&category=performance&category=best-practices&category=seo&category=accessibility&strategy=desktop&key=${PAGESPEED_API}`
        );
        const report = await response.json();

        session.set('lighthouse_report', {
            data: report.lighthouseResult,
            url: url,
            timestamp: Date.now()
        });
    } catch (error) {
        console.error("Error fetching PageSpeed data:", error);
        session.set('lighthouse_error', error.message);
    }
}
---
